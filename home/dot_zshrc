# ==========================================================================
#  ~/.zshrc — sheldon-managed, vi-mode, starship prompt
# ==========================================================================

# --------------------------------------------------------------------------
# 0. Profiling (uncomment to debug startup time)
# --------------------------------------------------------------------------
# zmodload zsh/zprof

# --------------------------------------------------------------------------
# 1. Environment
# --------------------------------------------------------------------------
export LANG="en_US.UTF-8"
export LC_ALL="en_US.UTF-8"
export EDITOR="vim"
export VISUAL="vim"
export PAGER="less"
export LESS="-R -F -X --mouse"
export MANPAGER="less -R"

# XDG base directories
export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
export XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
export XDG_CACHE_HOME="${XDG_CACHE_HOME:-$HOME/.cache}"
export XDG_STATE_HOME="${XDG_STATE_HOME:-$HOME/.local/state}"

# Ensure common paths
typeset -U path  # deduplicate
path=(
  "$HOME/.local/bin"
  "$HOME/bin"
  "/usr/local/bin"
  "/usr/local/sbin"
  $path
)

# --------------------------------------------------------------------------
# 2. Homebrew (macOS + Linux)
# --------------------------------------------------------------------------
if [[ -x /opt/homebrew/bin/brew ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -x /home/linuxbrew/.linuxbrew/bin/brew ]]; then
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
elif [[ -x "$HOME/.linuxbrew/bin/brew" ]]; then
  eval "$("$HOME/.linuxbrew/bin/brew" shellenv)"
fi

# --------------------------------------------------------------------------
# 3. History — exhaustive, deduplicated, shared across sessions
# --------------------------------------------------------------------------
HISTFILE="${XDG_STATE_HOME}/zsh/history"
[[ -d "${HISTFILE:h}" ]] || mkdir -p "${HISTFILE:h}"
HISTSIZE=1000000          # in-memory history lines
SAVEHIST=1000000          # on-disk history lines

setopt EXTENDED_HISTORY          # timestamps in history
setopt HIST_EXPIRE_DUPS_FIRST    # expire dupes first when trimming
setopt HIST_FIND_NO_DUPS         # don't show dupes in search
setopt HIST_IGNORE_ALL_DUPS      # remove older duplicates
setopt HIST_IGNORE_SPACE         # don't record commands starting with space
setopt HIST_REDUCE_BLANKS        # remove excess blanks
setopt HIST_SAVE_NO_DUPS         # no dupes on disk
setopt HIST_VERIFY               # show before executing history expansion
setopt INC_APPEND_HISTORY        # append immediately, don't wait for exit
setopt SHARE_HISTORY             # share across sessions

# --------------------------------------------------------------------------
# 4. General shell options
# --------------------------------------------------------------------------
setopt AUTO_CD                   # cd into directories by name alone
setopt AUTO_PUSHD                # push dirs onto stack automatically
setopt PUSHD_IGNORE_DUPS         # no dupes on dir stack
setopt PUSHD_SILENT              # don't print dir stack
setopt EXTENDED_GLOB             # advanced globbing
setopt INTERACTIVE_COMMENTS      # allow comments in interactive shell
setopt NO_BEEP                   # silence
setopt CORRECT                   # suggest corrections for commands
setopt COMPLETE_IN_WORD          # complete from both ends of cursor
setopt ALWAYS_TO_END             # move cursor to end after completion
setopt PATH_DIRS                 # search PATH for command-like arguments
setopt MULTIOS                   # allow multiple redirections

# --------------------------------------------------------------------------
# 5. pyenv
# --------------------------------------------------------------------------
export PYENV_ROOT="${PYENV_ROOT:-$HOME/.pyenv}"
if [[ -d "$PYENV_ROOT" ]]; then
  path=("$PYENV_ROOT/bin" $path)
  eval "$(pyenv init --path)"
  eval "$(pyenv init -)"
  # virtualenvwrapper via pyenv
  if pyenv commands 2>/dev/null | grep -q virtualenvwrapper; then
    pyenv virtualenvwrapper_lazy 2>/dev/null
  fi
fi

# --------------------------------------------------------------------------
# 6. nvm (lazy-loaded for speed)
# --------------------------------------------------------------------------
export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
export NVM_LAZY_LOAD=true
export NVM_COMPLETION=true
if [[ -s "$NVM_DIR/nvm.sh" ]]; then
  # Lazy-load nvm: define placeholder functions
  __lazy_nvm() {
    unfunction nvm node npm npx 2>/dev/null
    source "$NVM_DIR/nvm.sh"
    [[ -s "$NVM_DIR/bash_completion" ]] && source "$NVM_DIR/bash_completion"
  }
  for cmd in nvm node npm npx; do
    eval "${cmd}() { __lazy_nvm && ${cmd} \"\$@\"; }"
  done
fi

# pnpm
export PNPM_HOME="${XDG_DATA_HOME}/pnpm"
[[ -d "$PNPM_HOME" ]] && path=("$PNPM_HOME" $path)

# bun
export BUN_INSTALL="${BUN_INSTALL:-$HOME/.bun}"
[[ -d "$BUN_INSTALL" ]] && path=("$BUN_INSTALL/bin" $path)

# --------------------------------------------------------------------------
# 7. SSH agent
# --------------------------------------------------------------------------
export SSH_AGENT_IDENTITIES="id_ed25519 id_rsa"

# --------------------------------------------------------------------------
# 8. tmux — auto-attach or create session
# --------------------------------------------------------------------------
export ZSH_TMUX_AUTOSTART=false       # don't auto-start; we handle it below
export ZSH_TMUX_AUTOCONNECT=true
export ZSH_TMUX_UNICODE=true

if command -v tmux &>/dev/null && [[ -z "$TMUX" && -z "$VSCODE_PID" && -z "$INTELLIJ_ENVIRONMENT_READER" ]]; then
  tmux attach -t default 2>/dev/null || tmux new-session -s default
fi

# --------------------------------------------------------------------------
# 9. Sheldon — load all plugins
# --------------------------------------------------------------------------
if command -v sheldon &>/dev/null; then
  eval "$(sheldon source)"
fi

# --------------------------------------------------------------------------
# 10. Completion system (after sheldon loads plugins)
# --------------------------------------------------------------------------
autoload -Uz compinit
# Rebuild comp dump once a day for speed
if [[ -n "${XDG_CACHE_HOME}/zsh/zcompdump"(#qN.mh+24) ]]; then
  compinit -d "${XDG_CACHE_HOME}/zsh/zcompdump"
else
  compinit -C -d "${XDG_CACHE_HOME}/zsh/zcompdump"
fi

# Completion styling
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' 'r:|[._-]=* r:|=*' 'l:|=* r:|=*'
zstyle ':completion:*' menu select
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
zstyle ':completion:*' group-name ''
zstyle ':completion:*:descriptions' format '%F{yellow}-- %d --%f'
zstyle ':completion:*:warnings' format '%F{red}-- no matches --%f'
zstyle ':completion:*:default' list-prompt '%S%M matches%s'
zstyle ':completion:*' squeeze-slashes true
zstyle ':completion:*' accept-exact '*(N)'
zstyle ':completion:*' use-cache on
zstyle ':completion:*' cache-path "${XDG_CACHE_HOME}/zsh/zcompcache"

# fzf-tab styling (if loaded)
zstyle ':fzf-tab:*' fzf-flags --color=fg:7,bg:-1,hl:4,fg+:15,bg+:8,hl+:4,info:2,prompt:4,pointer:1,marker:1,spinner:3
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'ls --color=always $realpath 2>/dev/null'
zstyle ':fzf-tab:complete:*:*' fzf-preview 'bat --color=always --line-range :80 $realpath 2>/dev/null || ls --color=always $realpath 2>/dev/null'

# Docker completion
zstyle ':completion:*:*:docker:*' option-stacking yes
zstyle ':completion:*:*:docker-*:*' option-stacking yes

# --------------------------------------------------------------------------
# 11. Vi mode configuration (supplements zsh-vi-mode plugin)
# --------------------------------------------------------------------------
export ZVM_VI_INSERT_ESCAPE_BINDKEY=jk
export ZVM_LINE_INIT_MODE=$ZVM_MODE_INSERT
export ZVM_VI_HIGHLIGHT_FOREGROUND=white
export ZVM_VI_HIGHLIGHT_BACKGROUND=blue

# Restore key bindings that vi mode overrides
function zvm_after_init() {
  # fzf key bindings
  if [[ -f /usr/share/fzf/key-bindings.zsh ]]; then
    source /usr/share/fzf/key-bindings.zsh
  elif [[ -f "${HOMEBREW_PREFIX}/opt/fzf/shell/key-bindings.zsh" ]]; then
    source "${HOMEBREW_PREFIX}/opt/fzf/shell/key-bindings.zsh"
  fi

  # History substring search bindings (vi normal mode)
  bindkey -M vicmd 'k' history-substring-search-up
  bindkey -M vicmd 'j' history-substring-search-down
  bindkey '^[[A' history-substring-search-up
  bindkey '^[[B' history-substring-search-down
  bindkey '^P' history-substring-search-up
  bindkey '^N' history-substring-search-down

  # Ctrl-R for fzf history search even in vi mode
  bindkey '^R' fzf-history-widget 2>/dev/null || bindkey '^R' history-incremental-search-backward
}

# --------------------------------------------------------------------------
# 12. fzf configuration
# --------------------------------------------------------------------------
export FZF_DEFAULT_OPTS="
  --height 40%
  --layout=reverse
  --border
  --info=inline
  --color=fg:7,bg:-1,hl:4,fg+:15,bg+:8,hl+:4
  --color=info:2,prompt:4,pointer:1,marker:1,spinner:3,header:8
  --bind='ctrl-y:execute-silent(echo -n {+} | pbcopy 2>/dev/null || echo -n {+} | xclip -selection clipboard 2>/dev/null)'
  --bind='ctrl-/:toggle-preview'
"
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git 2>/dev/null || find . -type f -not -path "*/\.git/*"'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_CTRL_T_OPTS="--preview 'bat --color=always --line-range :200 {} 2>/dev/null || cat {}'"
export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git 2>/dev/null || find . -type d -not -path "*/\.git/*"'
export FZF_ALT_C_OPTS="--preview 'ls --color=always {} 2>/dev/null'"
export FZF_CTRL_R_OPTS="--preview 'echo {}' --preview-window down:3:hidden:wrap --bind '?:toggle-preview'"

# Load fzf if available
if [[ -f "${XDG_CONFIG_HOME}/fzf/fzf.zsh" ]]; then
  source "${XDG_CONFIG_HOME}/fzf/fzf.zsh"
elif command -v fzf &>/dev/null; then
  eval "$(fzf --zsh 2>/dev/null)"
fi

# --------------------------------------------------------------------------
# 13. Autosuggestion configuration
# --------------------------------------------------------------------------
export ZSH_AUTOSUGGEST_STRATEGY=(history completion)
export ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20
export ZSH_AUTOSUGGEST_USE_ASYNC=true
export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=8"

# --------------------------------------------------------------------------
# 14. AWS
# --------------------------------------------------------------------------
export AWS_PAGER=""
export AWS_DEFAULT_OUTPUT="json"
# AWS CLI completion
if command -v aws_completer &>/dev/null; then
  complete -C aws_completer aws
fi

# --------------------------------------------------------------------------
# 15. Docker
# --------------------------------------------------------------------------
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

# --------------------------------------------------------------------------
# 16. LLM / AI tool environment
# --------------------------------------------------------------------------
# API keys should be in ~/.config/secrets/env (sourced below, NOT in this file)
# These are safe defaults and helper aliases

# OpenAI
alias oai='openai'

# Anthropic / Claude
alias claude-api='curl -s https://api.anthropic.com/v1/messages'

# GitHub Copilot CLI (if installed)
if command -v gh &>/dev/null; then
  alias ghcs='gh copilot suggest'
  alias ghce='gh copilot explain'
fi

# llm CLI (Simon Willison's tool)
if command -v llm &>/dev/null; then
  alias ask='llm'
  alias chat='llm chat'
fi

# --------------------------------------------------------------------------
# 17. Aliases — general
# --------------------------------------------------------------------------
# ls (prefer eza > exa > ls)
if command -v eza &>/dev/null; then
  alias ls='eza --icons --group-directories-first'
  alias ll='eza -alh --icons --group-directories-first --git'
  alias la='eza -a --icons --group-directories-first'
  alias lt='eza --tree --level=2 --icons'
elif command -v exa &>/dev/null; then
  alias ls='exa --icons --group-directories-first'
  alias ll='exa -alh --icons --group-directories-first --git'
  alias la='exa -a --icons --group-directories-first'
  alias lt='exa --tree --level=2 --icons'
else
  alias ls='ls --color=auto'
  alias ll='ls -alFh'
  alias la='ls -A'
fi

alias grep='grep --color=auto'
alias fgrep='fgrep --color=auto'
alias egrep='egrep --color=auto'
alias diff='diff --color=auto'

# safety
alias rm='rm -i'
alias mv='mv -i'
alias cp='cp -i'

# navigation
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias -- -='cd -'

# misc
alias path='echo $PATH | tr ":" "\n"'
alias reload='exec zsh'
alias zshrc='${EDITOR} ~/.zshrc'
alias ports='ss -tulanp 2>/dev/null || netstat -tulanp 2>/dev/null'
alias myip='curl -s https://ifconfig.me'
alias weather='curl -s "wttr.in?format=3"'
alias duf='du -sh * | sort -rh | head -20'

# --------------------------------------------------------------------------
# 18. Aliases — git shortcuts (supplement oh-my-zsh git plugin)
# --------------------------------------------------------------------------
alias glog='git log --oneline --graph --decorate --all'
alias gwip='git add -A && git commit -m "WIP [skip ci]"'
alias gunwip='git log -1 --format=%s | grep -q "WIP" && git reset HEAD~1'

# --------------------------------------------------------------------------
# 19. Aliases — Docker shortcuts
# --------------------------------------------------------------------------
alias dps='docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Ports}}"'
alias dex='docker exec -it'
alias dlogs='docker logs -f'
alias dcu='docker compose up -d'
alias dcd='docker compose down'
alias dcr='docker compose restart'
alias dcl='docker compose logs -f'

# --------------------------------------------------------------------------
# 20. Aliases — systemd (supplement oh-my-zsh systemd plugin)
# --------------------------------------------------------------------------
alias jctl='journalctl -xe'
alias jctlf='journalctl -f'

# --------------------------------------------------------------------------
# 21. Aliases — Python
# --------------------------------------------------------------------------
alias py='python3'
alias ipy='ipython'
alias pip='python3 -m pip'
alias venv='python3 -m venv'
alias act='source .venv/bin/activate 2>/dev/null || source venv/bin/activate 2>/dev/null'
alias serve='python3 -m http.server'

# --------------------------------------------------------------------------
# 22. Aliases — tmux
# --------------------------------------------------------------------------
alias ta='tmux attach -t'
alias tn='tmux new-session -s'
alias tl='tmux list-sessions'
alias tk='tmux kill-session -t'

# --------------------------------------------------------------------------
# 23. Functions
# --------------------------------------------------------------------------

# Create dir and cd into it
mkcd() { mkdir -p "$1" && cd "$1"; }

# Extract any archive
extract() {
  if [[ -f "$1" ]]; then
    case "$1" in
      *.tar.bz2) tar xjf "$1"    ;;
      *.tar.gz)  tar xzf "$1"    ;;
      *.tar.xz)  tar xJf "$1"    ;;
      *.bz2)     bunzip2 "$1"    ;;
      *.rar)     unrar x "$1"    ;;
      *.gz)      gunzip "$1"     ;;
      *.tar)     tar xf "$1"     ;;
      *.tbz2)    tar xjf "$1"    ;;
      *.tgz)     tar xzf "$1"    ;;
      *.zip)     unzip "$1"      ;;
      *.Z)       uncompress "$1" ;;
      *.7z)      7z x "$1"       ;;
      *.zst)     unzstd "$1"     ;;
      *)         echo "Cannot extract '$1'" ;;
    esac
  else
    echo "'$1' is not a valid file"
  fi
}

# SSH with tmux auto-attach on remote
ssht() {
  ssh -t "$@" 'tmux attach -t default 2>/dev/null || tmux new-session -s default'
}

# Quick AWS profile switch
awsp() {
  export AWS_PROFILE="$1"
  echo "Switched to AWS profile: $AWS_PROFILE"
}

# Docker shell into a container
dsh() {
  docker exec -it "$1" sh -c 'exec bash 2>/dev/null || exec sh'
}

# --------------------------------------------------------------------------
# 24. Secrets — source API keys from a private, un-committed file
# --------------------------------------------------------------------------
[[ -f "${XDG_CONFIG_HOME}/secrets/env" ]] && source "${XDG_CONFIG_HOME}/secrets/env"

# --------------------------------------------------------------------------
# 25. Local overrides — machine-specific settings
# --------------------------------------------------------------------------
[[ -f "${HOME}/.zshrc.local" ]] && source "${HOME}/.zshrc.local"

# --------------------------------------------------------------------------
# 26. Starship prompt (must be last)
# --------------------------------------------------------------------------
if command -v starship &>/dev/null; then
  eval "$(starship init zsh)"
fi

# --------------------------------------------------------------------------
# 27. Profiling end (uncomment together with top)
# --------------------------------------------------------------------------
# zprof
